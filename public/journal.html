<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="style.css">

</head>

<body>

  <nav>
    <a href="/new">New Entry</a>
  </nav>

  <main>

    <p id="no-entries-placeholder">There are no journal entries yet.<br \> Upload one from the <a href="/new">New Entry</a> page.</p>

    <div id="journal"></div>

    <button id="load-more" class="btn" onclick="loadMoreEntries(10)">Load 10 more</button>

  </main>

  <script>

  var doc = document.getElementById("journal")
  var already = 0

  loadMoreEntries(9)

  function loadMoreEntries(n) {
    let xhr = new XMLHttpRequest()
    xhr.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {

        let a = JSON.parse(xhr.responseText)
        appendEntries(a)

        checkIfEntriesExist()

        if (a.length < n) {
          document.getElementById("load-more").style.visibility = "hidden";
        }

        already += a.length
      }
    }
    xhr.open("GET", `/api/entries/${already}/${already + n}`, true)
    xhr.send()
  }

  function appendEntries(data) {
    for (let i=0; i<data.length; i++) {
      doc.appendChild(buildEntry(data[i]))
    }
  }

  function showFullImage(timestamp) {
    let fullImage = document.createElement("div")
    fullImage.id = "full-image"
    fullImage.style.backgroundImage = `url(/api/photos/${timestamp}.jpg`
    fullImage.style.cursor = "pointer"
    document.body.appendChild(fullImage)

    fullImage.onclick = function() {
      this.remove()
    }
  }

  function buildEntry(s) {

    let date = new Date(s.timestamp)

    let months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
    let dateString = `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`
    let hasPhoto = (s.hasPhoto)
    let photoUrl = `/api/photos/${s.timestamp}.jpg`
    let text = s.entryText

    let entryEl = document.createElement("div")
    entryEl.classList.add("journal-entry")

    let dateEl = document.createElement("span")
    dateEl.classList.add("date")
    dateEl.textContent = dateString

    let deleteBtn = document.createElement("button")
    deleteBtn.textContent = "X"
    deleteBtn.classList.add("delete-btn")
    deleteBtn.onclick = function (e) {
      deleteEntry(this, s.timestamp)
        e.stopPropagation()
    }

    let textEl = document.createElement("p")
    textEl.classList.add("text")
    textEl.textContent = text

    if (hasPhoto) {
      entryEl.style.backgroundImage = `linear-gradient(#00000099, #00000077), url(${photoUrl})`
      entryEl.style.cursor = "pointer"

      entryEl.onmouseenter = (e) => {
        e.preventDefault()
        e.stopPropagation()
        entryEl.style.backgroundImage = `url(${photoUrl})`
        dateEl.style.visibility = "hidden"
        textEl.style.visibility = "hidden"
      }

      entryEl.onmouseleave = (e) => {
        e.preventDefault()
        e.stopPropagation()
        entryEl.style.backgroundImage = `linear-gradient(#00000099, #00000077), url(${photoUrl})`
        dateEl.style.visibility = "visible"
        textEl.style.visibility = "visible"
      }

      entryEl.onclick = (e) => {
        e.preventDefault()
        e.stopPropagation()
        showFullImage(s.timestamp)
      }
    }

    entryEl.appendChild(dateEl)
    entryEl.appendChild(textEl)
    entryEl.appendChild(deleteBtn)

    return entryEl
  }

  /* Deletes an entry from the database and then removes it from the DOM */
  function deleteEntry(element, timestamp) {

    if (!window.confirm("Are you sure you want to delete this entry?")) {
      return
    }

    // Start a new AJAX request
    let xhr = new XMLHttpRequest()
    xhr.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {

        // When the request come back correctly, remove the entry from the DOM
        element.parentElement.remove()

        // If most recent post was the only post, show the "no entries exist" text
        checkIfEntriesExist()
      }
    }

    // Call the API to remove the entry
    xhr.open("GET", `/api/delete/${timestamp}`, true)
    xhr.send()
  }

  /* This function decides whether or not to display the "no entries exits" text */
  function checkIfEntriesExist() {
    let entriesCount = document.getElementById("journal").childElementCount
    let placeholderEl = document.getElementById("no-entries-placeholder")

    if (entriesCount > 0) {
      placeholderEl.hidden = true;
    }
    else {
      placeholderEl.hidden = false;
    }
  }

  </script>
</body>
</html>
